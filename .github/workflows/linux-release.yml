# SPDX-FileCopyrightText: 2026 Juan Medina
# SPDX-License-Identifier: MIT
ta
name: Build Linux release asset

on:
    release:
        types: [published]

permissions:
    contents: write

jobs:
    build-linux-and-attach:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  lfs: true

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: 3.x

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                      libasound2-dev \
                      libx11-dev \
                      libxrandr-dev \
                      libxi-dev \
                      libgl1-mesa-dev \
                      libglu1-mesa-dev \
                      libxcursor-dev \
                      libxinerama-dev \
                      libgtk-3-dev \
                      pkg-config

            - name: Configure
              run: |
                  cmake -S . -B build-linux -DCMAKE_BUILD_TYPE=Release -DENABLE_VERSION_BUMP=OFF

            - name: Build (Release)
              run: |
                  cmake --build build-linux --config Release

            - name: Package (binary + resources)
              run: |
                  tag="${{ github.ref_name }}"
                  app="energy-swap"
                  outDir="dist"
                  pkgDir="$outDir/$app-linux-x64-$tag"
                  tarPath="$outDir/$app-linux-x64-$tag.tar.gz"

                  mkdir -p "$pkgDir"

                  exe="build-linux/$app"
                  if [ ! -f "$exe" ]; then
                      echo "Executable not found: $exe"
                      exit 1
                  fi
                  cp "$exe" "$pkgDir/"

                  resources="build-linux/resources"
                  if [ ! -d "$resources" ]; then
                      echo "Missing packaged resources folder at: $resources"
                      exit 1
                  fi
                  cp -r "$resources" "$pkgDir/"

                  tar -czf "$tarPath" -C "$pkgDir" .

                  echo "TAR_PATH=$tarPath" >> $GITHUB_ENV

            - name: Attach tar.gz to GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: ${{ env.TAR_PATH }}
